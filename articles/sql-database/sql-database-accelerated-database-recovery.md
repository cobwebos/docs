---
title: 加速的数据库恢复 - Azure SQL 数据库 | Microsoft Docs
description: Azure SQL 数据库具有一项新功能，可为 Azure SQL 数据库中的单一数据库和入池数据库以及 Azure SQL 数据仓库中的数据库提供快速且一致的数据库恢复、即时事务回滚和主动性的日志截断。
ms.service: sql-database
ms.subservice: high-availability
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: mashamsft
ms.author: mathoma
ms.reviewer: carlrab
manager: craigg
ms.date: 01/25/2019
ms.openlocfilehash: bb88da48f8961969176fd67bf6e5fa346655aeac
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/23/2019
ms.locfileid: "60388707"
---
# <a name="accelerated-database-recovery-preview"></a>加速的数据库恢复（预览）

**加速的数据库恢复 (ADR)** 是一项新的 SQL 数据库引擎功能，通过重新设计 SQL 数据库引擎恢复过程，极大地提高数据库可用性（尤其是存在长期运行的事务时）。 ADR 目前可用于 Azure SQL 数据库中的单一数据库和入池数据库，以及 Azure SQL 数据仓库中的数据库。 ADR 的主要优点是：

- **快速且一致的数据库恢复**

  使用 ADR，长期运行的事务不会影响总体恢复时间，可以实现快速一致的数据库恢复，而不考虑系统中的活动事务数量或其大小。

- **即时事务回滚**

  使用 ADR，可实现即时的事务回滚，而不考虑事务处于活动状态的时间或已执行的更新数。

- **主动性的日志截断**

  使用 ADR，即使存在长期运行的活动事务，也会主动地截断事务日志，从而防止事务日志在增长时失控。

## <a name="the-current-database-recovery-process"></a>当前的数据库恢复过程

SQL Server 中的数据库恢复遵循 [ARIES](https://people.eecs.berkeley.edu/~brewer/cs262/Aries.pdf) 恢复模式，由三个阶段组成，如下图所示，并在该示意图下附有详细的说明。

![当前的恢复过程](./media/sql-database-accelerated-database-recovery/current-recovery-process.png)

- **分析阶段**

  从最后一个成功的检查点 （或最早的脏页 LSN） 结束之前，以确定是在 SQL Server 停止每个事务的状态开始转发扫描的事务日志。

- **重做阶段**

  从最早的未提交事务结束时，将数据库恢复到它所处的状态以及出现故障时的重做已提交的所有操作直到转发扫描的事务日志。

- **撤消阶段**

  对于在故障时处于活动状态的每个事务，向后遍历日志，撤消该事务执行的操作。

基于此设计，SQL 数据库引擎从意外重启中恢复所需的时间（大致）与故障时系统中时间最长的活动事务的大小成正比。 恢复需要回滚所有不完整事务。 所需的时间长度与事务执行的工作量和事务处于活动状态的时间成正比。 因此，在存在长期运行的事务时，SQL Server 恢复过程可能需要很长时间（例如针对大型表的大批量插入操作或索引生成操作）。

此外，基于此设计，取消/回滚大型事务也可能需要很长时间，因为它使用与上述流程相同的撤消恢复阶段。

此外，在存在长期运行的事务时，SQL 数据库引擎无法截断事务日志，因为恢复和回滚过程需要相应的日志记录。 由于此设计的 SQL 数据库引擎，某些客户会面临该问题的事务日志大小变得非常大，并使用数量庞大的驱动器空间。

## <a name="the-accelerated-database-recovery-process"></a>加速的数据库恢复过程

ADR 通过完全重新设计 SQL 数据库引擎恢复过程来解决上述问题，具体内容如下：

- 避免必须从最早的活动事务开始扫描日志，从而实现固定时间恢复和即时恢复。 使用 ADR，事务日志仅处理从最后一个成功的检查点 （或最早的脏页日志序列号 (LSN)）。 因此，恢复时间不受长期运行的事务影响。
- 最大程度地减少所需的事务日志空间，因为不再需要处理全部事务的日志。 因此，出现检查点并发生备份时，可以主动地截断事务日志。

在高级别上，ADR 通过对所有物理数据库修改进行版本控制并仅撤消逻辑操作来实现快速数据库恢复（这些操作是有限的，并且几乎可以立即撤消）。 在故障时处于活动状态的任何事务都被标记为已中止，因此，并发用户查询可以忽略这些事务生成的任何版本。

ADR 恢复过程具有与当前恢复过程相同的三个阶段。 下图说明了这些阶段在 ADR 中的运作方式，并在该示意图后附带了详细的说明。

![ADR 恢复过程](./media/sql-database-accelerated-database-recovery/adr-recovery-process.png)

- **分析阶段**

  该进程保持与现在添加了重新构造 sLog 和复制非版本化操作的日志记录的相同。
  
- **重做**阶段

  分为两个阶段 (P)
  - 阶段 1

      从 sLog 开始恢复（从最早的未提交事务到最后一个检查点）。 重做阶段是一个快速操作，因为仅需处理几条 sLog 记录。
      
  - 阶段 2

     从事务日志开始恢复，从最后一个检查点（而不是最早的未提交事务）开始
     
- **撤消阶段**

   使用 ADR 的撤销阶段几乎是瞬间完成的，方法是使用 sLog 通过逻辑还原撤消非版本化操作和持久版本存储 (PVS) 以在行级别执行基于版本的撤消。

## <a name="adr-recovery-components"></a>ADR 恢复的组成要素

ADR 的四个关键的组成要素为：

- **持久版本存储 (PVS)**

  持久版本存储是一种新的 SQL 数据库引擎机制，用于持久保存在数据库本身生成生成（而不是在传统的 `tempdb` 版本存储中生成）的行版本。 PVS 支持资源隔离，并提高可读辅助数据库的可用性。

- **逻辑还原**

  逻辑还原是异步过程负责执行行级版本基于撤消-所有版本控制操作提供即时事务回滚和撤消。

  - 跟踪所有已中止事务
  - 使用 PVS 执行所有用户事务的回滚操作
  - 在事务中止后立即发布所有锁定

- **sLog**

  sLog 是辅助内存日志流，用于存储非版本化操作的日志记录（例如元数据缓存无效、锁定获取等）。 sLog 具有以下特点：

  - 低容量并处于内存中
  - 在处理检查点时通过串行化保留在磁盘上
  - 在事务提交时定期截断
  - 通过仅处理非版本化操作来加速重做阶段和撤消阶段  
  - 通过仅保留所需的日志记录实现主动地事务日志截断

- **清理器**

  清理器是会定期唤醒的异步过程，能清除不需要的页面版本。

## <a name="who-should-consider-accelerated-database-recovery"></a>加速的数据库恢复的适用对象

以下类型的客户应考虑启用 ADR：

- 工作负载带有长期运行事务的客户。
- 已发现活动事务导致事务日志显著增长的客户。  
- 已发现由于 SQL Server 恢复耗时很长（例如意外的 SQL Server 重启或手动事务回滚）导致数据库长时间不可用的客户。

## <a name="to-enable-adr-during-this-preview-period"></a>在此预览期间启用 ADR

请在此功能的预览期间，发送一封电子邮件至 [adr@microsoft.com](mailto:adr@microsoft.com) 以了解详细信息并试用加速的数据库恢复 (ADR)。 在电子邮件中，包含 SQL 数据库服务器的名称（适用于 SQL 数据库中的单一数据库和入池数据库，以及 Azure 数据仓库中的数据库）。 由于这是一项预览功能，测试服务器应为非生产服务器。
