---
title: 系统状态和裸机恢复保护
description: 使用 Azure 备份服务器备份系统状态并提供裸机恢复（BMR）保护。
ms.topic: conceptual
ms.date: 05/15/2017
ms.openlocfilehash: bab55ca607e0641ea0cc597de686f3abbb387598
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/28/2020
ms.locfileid: "82192359"
---
# <a name="back-up-system-state-and-restore-to-bare-metal-by-using-azure-backup-server"></a>使用 Azure 备份服务器备份系统状态并将计算机还原成裸机

Azure 备份服务器备份系统状态，并提供裸机恢复 (BMR) 保护。

* **系统状态备份**：备份操作系统文件。 通过这种备份可以在计算机启动时进行恢复，但系统文件和注册表会丢失。 系统状态备份包括以下要素：
  * 域成员：启动文件、COM+ 类注册数据库、注册表
  * 域控制器：Windows Server Active Directory (NTDS)、启动文件、COM+ 类注册数据库、注册表、系统卷 (SYSVOL)
  * 运行群集服务的计算机：群集服务器元数据
  * 运行证书服务的计算机：证书数据
* **裸机备份**：备份操作系统文件和关键卷上的所有数据（用户数据除外）。 根据定义，BMR 备份包括系统状态备份。 在计算机不会启动的情况下，如果必须彻底恢复，则可通过此备份获得保护。

下表总结了可以备份和恢复的内容。 有关可以通过系统状态和 BMR 保护的应用版本的信息，请参阅 [Azure 备份服务器备份哪些内容？](backup-mabs-protection-matrix.md)。

|Backup|问题|从 Azure 备份服务器备份恢复|从系统状态备份恢复|BMR|
|----------|---------|---------------------------|------------------------------------|-------|
| 文件数据<br /><br />常规数据备份<br /><br />BMR/系统状态备份|丢失文件数据|Y|N|N|
| 文件数据<br /><br />对文件数据进行 Azure 备份服务器备份<br /><br />BMR/系统状态备份|丢失或损坏操作系统|N|Y|Y|
| 文件数据<br /><br />对文件数据进行 Azure 备份服务器备份<br /><br />BMR/系统状态备份|丢失服务器（数据卷完整）|N|N|Y|
| 文件数据<br /><br />对文件数据进行 Azure 备份服务器备份<br /><br />BMR/系统状态备份|丢失服务器（数据卷丢失）|Y|N|Y<br /><br />BMR，随后对已备份文件数据进行常规恢复|
|**SharePoint 数据**<br /><br />对场数据进行 Azure 备份服务器备份<br /><br />BMR/系统状态备份|丢失站点、列表、列表项、文档|Y|N|N|
|**SharePoint 数据**<br /><br />对场数据进行 Azure 备份服务器备份<br /><br />BMR/系统状态备份|丢失或损坏操作系统|N|Y|Y|
|**SharePoint 数据**<br /><br />对场数据进行 Azure 备份服务器备份<br /><br />BMR/系统状态备份|灾难恢复|N|N|N|
|Windows Server 2012 R2 Hyper-V<br /><br />对 Hyper-V 主机或来宾进行 Azure 备份服务器备份<br /><br />对主机进行 BMR/系统状态备份|丢失 VM|Y|N|N|
|Hyper-V<br /><br />对 Hyper-V 主机或来宾进行 Azure 备份服务器备份<br /><br />对主机进行 BMR/系统状态备份|丢失或损坏操作系统|N|Y|Y|
|Hyper-V<br /><br />对 Hyper-V 主机或来宾进行 Azure 备份服务器备份<br /><br />对主机进行 BMR/系统状态备份|丢失 Hyper-V 主机（VM 完整）|N|N|Y|
|Hyper-V<br /><br />对 Hyper-V 主机或来宾进行 Azure 备份服务器备份<br /><br />对主机进行 BMR/系统状态备份|丢失 Hyper-V 主机（VM 丢失）|N|N|Y<br /><br />BMR，随后进行常规 Azure 备份服务器恢复|
|SQL Server/Exchange<br /><br />Azure 备份服务器应用备份<br /><br />BMR/系统状态备份|丢失应用数据|Y|N|N|
|SQL Server/Exchange<br /><br />Azure 备份服务器应用备份<br /><br />BMR/系统状态备份|丢失或损坏操作系统|N|Y|Y|
|SQL Server/Exchange<br /><br />Azure 备份服务器应用备份<br /><br />BMR/系统状态备份|服务器丢失（数据库/事务日志完整）|N|N|Y|
|SQL Server/Exchange<br /><br />Azure 备份服务器应用备份<br /><br />BMR/系统状态备份|服务器丢失（数据库/事务日志丢失）|N|N|Y<br /><br />BMR 恢复，随后进行常规 Azure 备份服务器恢复|

## <a name="how-system-state-backup-works"></a>系统状态备份工作原理

当系统状态备份运行时，备份服务器会与 Windows Server 备份通信，请求对服务器的系统状态进行备份。 默认情况下，备份服务器和 Windows Server 备份会使用可用空间可用程度最高的驱动器。 有关该驱动器的信息保存在 *PSDataSourceConfig.xml* 文件中。

可以自定义驱动器，供备份服务器用于系统状态备份：

1. 在受保护的服务器上，转到 *C:\Program Files\Microsoft Data Protection Manager\MABS\Datasources*。
1. 打开 *PSDataSourceConfig.xml* 文件进行编辑。
1. 更改驱动器号的 \<FilesToProtect\> 值。
1. 保存并关闭该文件。

如果设置了某个保护组来保护计算机的系统状态，请运行一致性检查。 如果生成了警报，请在警报中选择“修改保护组”，并完成向导中的页面。  然后再次运行一致性检查。

如果保护服务器位于群集中，则可能会选择群集驱动器作为可用空间最多的驱动器。 如果该驱动器的所有权已切换到另一节点，且系统状态备份已运行，则该驱动器将不可用，备份将会失败。 在这种情况下，请将 *PSDataSourceConfig.xml* 修改为指向本地驱动器。

接下来，Windows Server 备份在还原文件夹的根目录中创建名为 *WindowsImageBackup* 的文件夹。 Windows Server 备份创建备份以后，所有数据就会置于该文件夹中。 备份完成后，文件将传输到备份服务器计算机。 请注意以下信息：

* 备份或传输完成时不会清理该文件夹及其内容。 更准确地说，系统会保留该空间来完成下一次备份。
* 每次备份都会创建该文件夹。 时间和日期戳反映了上次系统状态备份的时间。

## <a name="how-bmr-backup-works"></a>BMR 备份的工作原理

进行 BMR（包括系统状态备份）时，备份作业直接保存到备份服务器计算机上的共享中， 而不是保存到受保护服务器上的文件夹中。

备份服务器调用 Windows Server 备份，并共享该 BMR 备份的副本卷。 在这种情况下，它不会要求 Windows Server 备份使用可用空间最多的驱动器， 而是使用为作业创建的共享。

备份完成后，文件将传输到备份服务器计算机。 日志存储在 *C:\Windows\Logs\WindowsServerBackup* 中。

## <a name="prerequisites-and-limitations"></a>先决条件和限制

* 运行 Windows Server 2003 或客户端操作系统的计算机不支持 BMR。

* 不能在不同保护组中对同一计算机实施 BMR 和系统状态保护。

* 备份服务器计算机不能在 BMR 时进行自我保护。

* BMR 时，不支持通过备份到磁带（磁盘到磁带，简称 D2T）进行短期保护。 支持长期存储到磁带（磁盘到磁盘再到磁带，简称 D2D2T）。

* 若要进行 BMR 保护，必须将 Windows Server 备份安装在受保护计算机上。

* 进行 BMR 保护时，备份服务器对受保护计算机没有任何空间要求，这一点与系统状态保护不同。 Windows Server 备份直接将备份传输到备份服务器计算机。 备份传输作业不显示在备份服务器的“作业”视图中。 

* 备份服务器在 BMR 的副本卷上保留 30 GB 的空间。 可以在“修改保护组向导”的“磁盘分配”页中更改此空间分配。  或者，可以使用 Get-DatasourceDiskAllocation 和 Set-DatasourceDiskAllocation PowerShell cmdlet。 在恢复点卷上，BMR 保护需要大约 6 GB 的空间对内容保留五天的时间。
  * 不能将副本卷大小降到 15 GB 以下。
  * 备份服务器不计算 BMR 数据源的大小， 而是对所有服务器都假定一个 30 GB 的大小。 请根据环境中预期会进行的 BMR 备份的大小更改此值。 粗略计算的话，BMR 备份的大小就是所有关键卷上已用空间之和。 关键卷 = 启动卷 + 系统卷 + 托管系统状态数据的卷，例如 Active Directory。

* 如果从系统状态保护更改为 BMR 保护，则 BMR 保护在恢复点卷上需要较少的空间，  但系统不会回收该卷上的多余空间。 可以在“修改保护组向导”的“修改磁盘分配”页中手动缩减卷大小。  或者，可以使用 Get-DatasourceDiskAllocation 和 Set-DatasourceDiskAllocation PowerShell cmdlet。

    如果从系统状态保护更改为 BMR 保护，则 BMR 保护在副本卷上需要较多的空间，  系统会自动扩展该卷。 若要更改默认的空间分配，请使用 Modify-DiskAllocation PowerShell cmdlet。

* 如果从 BMR 保护更改为系统状态保护，则需要恢复点卷上有较多的空间。 备份服务器可能会尝试自动增大卷。 如果存储池中没有足够的空间，就会出错。

    如果从 BMR 保护更改为系统状态保护，则受保护计算机上需有空间。 之所以需要空间，是因为系统状态保护首先将副本写入本地计算机，然后将副本传输到备份服务器计算机。

## <a name="before-you-begin"></a>准备阶段

1.  部署 Azure 备份服务器。 验证备份服务器是否已正确部署。 有关详细信息，请参阅：
    * [Azure 备份服务器的系统要求](https://docs.microsoft.com/system-center/dpm/install-dpm#setup-prerequisites)
    * [备份服务器保护矩阵](backup-mabs-protection-matrix.md)

1.  设置存储。 可以将备份数据存储在磁盘、磁带以及 Azure 云中。 有关详细信息，请参阅 [Prepare data storage](https://docs.microsoft.com/system-center/dpm/plan-long-and-short-term-data-storage)（准备数据存储）。

1.  设置保护代理。 在要备份的计算机上安装保护代理。 有关详细信息，请参阅 [Deploy the DPM protection agent](https://docs.microsoft.com/system-center/dpm/deploy-dpm-protection-agent)（部署 DPM 保护代理）。

## <a name="back-up-system-state-and-bare-metal"></a>备份系统状态和裸机

若要备份系统状态和裸机：

1. 若要在备份服务器管理员控制台中打开“新建保护组向导”，请选择“保护”   > “操作”   >   “创建保护组”。

1. 在“选择保护组类型”页上选择“服务器”，然后选择“下一步”。   

1. 在“选择组成员”页上展开计算机，然后选择“BMR”或“系统状态”。   

    请记住，不能在不同组中对同一计算机实施 BMR 和系统状态保护。 此外，在选择 BMR 时，会自动启用系统状态。 有关详细信息，请参阅 [Deploy protection groups](https://docs.microsoft.com/system-center/dpm/create-dpm-protection-groups)（部署保护组）。

1. 在“选择数据保护方法”页上，选择要如何处理短期和长期备份。 

    短期备份始终先备份到磁盘，然后可以选择通过 Azure 备份从磁盘备份到 Azure（短期或长期）。 可以设置一种长期备份，备份到单独的磁带设备或连接到备份服务器的磁带库，替代长期备份到云。

1. 在“选择短期目标”页上，选择要如何备份到磁盘上的短期存储： 
    * 对于“保留期”，请选择要将数据保留在磁盘上多长时间。 
    * 对于“同步频率”，请选择增量备份到磁盘的频率。  如果不想设置备份间隔，可以选择“就在恢复点之前”。  备份服务器会刚好在计划每个恢复点之前运行快速的完整备份。

1. 若要将数据存储在磁带上进行长期存储，请在“指定长期目标”页上选择要保留磁带数据多长时间（1 到 99 年）。 
    1. 对于“备份频率”，请选择备份到磁带的频率。  频率取决于所选的保留期：
        * 如果保留期为 1 到 99 年，则可以每日、每周、每两周、每月、每季、每半年或每年备份一次。
        * 如果保留期为 1 到 11 月，则可以每日、每周、每两周或每月备份一次。
        * 如果保留期为 1 到 4 周，则可以每日或每周备份一次。

    1. 在“选择磁带和库详细信息”页上，选择要使用的磁带和库。  另外选择是否要压缩并加密数据。

1. 在“查看磁盘分配”页上，查看保护组可用的存储池磁盘空间。 

    * “数据总大小”  是要备份的数据的大小。
    * “要在 Azure 备份服务器上预配的磁盘空间”  是备份服务器为保护组建议的空间。 备份服务器使用这些设置来选择理想的备份卷。 你可以在“磁盘分配详细信息”中编辑备份卷选项。 
    * 对于工作负荷，请在下拉菜单中选择首选存储。 编辑时，更改的是“可用磁盘存储”  窗格中的“总存储”  和“可用存储”  值。 “预配不足的空间”是指备份服务器建议你添加到卷的存储量，目的是确保顺利备份。

1. 在“选择副本创建方法”页上，选择要如何处理初始的完整数据复制。 

    如果选择通过网络复制，则建议选择非高峰时间。 如果数据量很大或者网络状况欠佳，请考虑使用可移动介质脱机复制数据。

1. 在“选择一致性检查选项”页上，选择要如何自动执行一致性检查。 

    可以选择仅在副本数据变得不一致时运行检查，或者按计划运行检查。 如果不想配置自动一致性检查，可以随时运行手动检查。 若要运行手动检查，请在备份服务器管理员控制台的“保护”  区域中，右键单击保护组，然后选择“执行一致性检查”  。

1. 如果选择使用 Azure 备份来备份到云，请在“指定联机保护数据”页上，选择要备份到 Azure 的工作负荷。 

1. 在“指定联机备份计划”页上，选择增量备份到 Azure 的频率。 

    可将备份计划为每日、每周、每月和每年运行。 还可以选择运行备份的时间和日期。 备份一天最多可以进行两次。 每次备份运行时，会通过备份服务器磁盘上存储的备份数据的副本在 Azure 中创建数据恢复点。

1. 在“指定联机保留策略”页上，选择如何在 Azure 中保留通过每日、每周、每月和每年备份创建的恢复点。 

1. 在“选择联机复制”  页上，选择如何进行数据的初始完整复制。

    可以通过网络复制，也可以脱机备份（脱机种子设定）。 脱机备份使用 Azure 导入功能。 有关详细信息，请参阅 [Azure 备份中的脱机备份工作流](offline-backup-azure-data-box.md)。

1. 在“摘要”**** 页上，检查设置。 选择“创建组”**** 之后，进行数据的初始复制。 数据复制完成后，在 "**状态**" 页上，保护组状态为 **"正常"**。 然后，将根据保护组设置进行备份。

## <a name="recover-system-state-or-bmr"></a>恢复系统状态或 BMR

可以将 BMR 或系统状态恢复到网络位置。 如果已备份 BMR，请使用 Windows 恢复环境（WinRE）启动系统并将其连接到网络。 然后使用 Windows Server 备份 (WSB) 从网络位置恢复。 如果备份了系统状态，只需使用 Windows Server 备份从网络位置恢复即可。

### <a name="restore-bmr"></a>还原 BMR

若要在备份服务器计算机上运行恢复：

1. 在 "**恢复**" 窗格中，找到要恢复的计算机。 然后选择 "**裸机恢复**"。

1. 可用恢复点在日历上以粗体进行指示。 为要使用的恢复点选择日期和时间。

1. 在 "**选择恢复类型**" 页上，选择 "**复制到网络文件夹**"。

1. 在 "**指定目标**" 页上，选择复制数据的目标。

    请记住，目标需要有足够的空间来容纳数据。 建议为目标创建一个新文件夹。

1. 在 "**指定恢复选项**" 页上，选择 "安全设置"。 然后，选择是否要使用基于存储区域网络（SAN）的硬件快照进行更快的恢复。 此选项仅在以下情况下可用：
    * 你有一个提供此功能的 SAN。
    * 你可以创建和拆分克隆以使其可写。
    * 受保护的计算机和备份服务器计算机连接到同一网络。

1. 设置通知选项。
1. 在“确认”**** 页上，选择“恢复”****。

设置共享位置：

1. 在还原位置中，转到包含备份的文件夹。

1. 共享位于*WindowsImageBackup*上方一级的文件夹，以便共享文件夹的根目录是*WindowsImageBackup*文件夹。

    如果不共享此文件夹，restore 将找不到备份。 若要使用 WinRE 进行连接，需要一个可以使用正确的 IP 地址和凭据在 WinRE 中访问的共享。

还原系统：

1. 使用正在还原的系统的 Windows DVD，启动要在其上还原映像的计算机。

1. 在第一页上，验证语言和区域设置的设置。 在“安装”**** 页上，选择“修复计算机”****。

1. 在“系统恢复选项”**** 页上，选择“使用以前创建的系统映像还原计算机”****。

1. 在“选择系统镜像备份”**** 页上，选择“选择系统映像”**** > “高级”**** > “在网络上搜索系统映像”****。 如果出现警告，请选择“是”****。 转到共享路径，输入凭据，然后选择恢复点。 系统将扫描该恢复点中可用的特定备份。 选择要使用的恢复点。

1. 在 "**选择如何还原备份"** 页上，选择 "**格式化并重新分区磁盘**"。 在下一页上，验证设置。

1. 若要开始还原，请选择“完成”****。 需要重新启动。

### <a name="restore-system-state"></a>还原系统状态

在备份服务器中运行恢复：

1. 在“恢复”**** 窗格中，找到要恢复的计算机，然后选择“裸机恢复”****。

1. 可用恢复点在日历上以粗体进行指示。 为要使用的恢复点选择日期和时间。

1. 在 "**选择恢复类型**" 页上，选择 "**复制到网络文件夹**"。

1. 在 "**指定目标**" 页上，选择复制数据的位置。

    请记住，所选目标需要有足够的空间来容纳数据。 建议为目标创建一个新文件夹。

1. 在 "**指定恢复选项**" 页上，选择 "安全设置"。 然后，选择是否要使用基于 SAN 的硬件快照进行更快的恢复。 此选项仅在以下情况下可用：
    * 你有一个提供此功能的 SAN。
    * 你可以创建和拆分克隆以使其可写。
    * 受保护的计算机和备份服务器服务器连接到同一网络。

1. 设置通知选项。
1. 在“确认”**** 页上，选择“恢复”****。

若要运行 Windows Server 备份：

1. 选择 "**操作** > " "**恢复** > **此服务器** > **"。**

1. 选择“另一台服务器”****，选择“指定位置类型”**** 页，然后选择“远程共享文件夹”****。 输入包含恢复点的文件夹的路径。

1. 在“选择恢复类型”**** 页上，选择“系统状态”****。

1. 在“选择系统状态恢复的位置”**** 页上，选择“原始位置”****。

1. 在“确认”**** 页上，选择“恢复”****。

1. 还原之后，重新启动服务器。

你还可以在命令提示符处运行系统状态还原：

1. 在要恢复的计算机上启动 Windows Server 备份。

1. 若要获取版本标识符，请在命令提示符处输入：

   ```wbadmin get versions -backuptarget \<servername\sharename\>```

1. 使用版本标识符启动系统状态还原。 在命令提示符处，输入：

    ```wbadmin start systemstaterecovery -version:<versionidentified> -backuptarget:<servername\sharename>```

1. 确认要开始恢复。 可以在命令提示符窗口中查看过程。 会创建还原日志。

1. 还原之后，重新启动服务器。
