---
title: 'Azure Database for PostgreSQL 灵活的服务器 (预览版的区域冗余高可用性概述) '
description: 了解 Azure Database for PostgreSQL-灵活服务器的区域冗余高可用性的概念
author: sr-msft
ms.author: srranga
ms.service: postgresql
ms.topic: conceptual
ms.date: 09/22/2020
ms.openlocfilehash: 7db9ac0eb624c2732295639d65e0311fcf459f71
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/09/2020
ms.locfileid: "90933346"
---
# <a name="high-availability-concepts-in-azure-database-for-postgresql---flexible-server"></a>Azure Database for PostgreSQL-灵活服务器中的高可用性概念

> [!IMPORTANT]
> Azure Database for PostgreSQL 灵活服务器以预览版提供

Azure Database for PostgreSQL 灵活的服务器使用 **区域冗余** 服务器部署提供具有自动故障转移功能的高可用性配置。 当采用区域冗余配置进行部署时，灵活服务器会自动在不同的可用性区域中预配和管理备用副本。 使用 PostgreSQL 流式复制时，数据会在 **同步** 模式下复制到备用副本服务器。 

区域冗余配置在计划事件（例如用户启动的缩放计算操作）期间以及计划内事件（例如，基础硬件和软件故障、网络故障和可用性区域故障）期间启用自动故障转移功能，无数据丢失。 

:::image type="content" source="./media/business-continuity/concepts-zone-redundant-high-availability-architecture.png" alt-text="区域冗余高可用性"::: 

## <a name="zone-redundant-high-availability-architecture"></a>区域冗余高可用性体系结构

可以选择区域和可用性区域来部署主数据库服务器。 备用副本服务器在不同的可用性区域中进行预配，其配置与主服务器相同，包括计算层、计算大小、存储大小和网络配置。 使用 PostgreSQL 流式复制将事务日志以同步模式复制到备用副本。 自动备份会定期从主数据库服务器执行，而事务日志会持续从备用副本存档到备份存储。 

高可用性配置的运行状况将在门户上持续监视和报告。 区域冗余高可用性状态如下所示：

| **状态** | **说明** |
| ------- | ------ |
| <b> 出错 | 在创建新备用服务器的过程中 |
| <b> 复制数据 | 创建备用后，它会与主副本建立在一起。 |
| <b> 正常 | 复制处于稳定状态且正常。 |
| <b> 故障转移 | 数据库服务器正在故障转移到备用服务器。 |
| <b> 正在删除备用 | 正在删除备用服务器。 | 
| <b> 未启用 | 未启用区域冗余高可用性。  |

## <a name="steady-state-operations"></a>稳定状态操作

使用 DB 服务器名称将 PostgreSQL 客户端应用程序连接到主服务器。 应用程序读取是直接从主服务器提供的，而只有在主服务器和备用副本上保存了数据后，才会向应用程序确认提交和写入。 由于这一额外的往返要求，应用程序可能会预计写入和提交的延迟。 可以在门户上监视高可用性的运行状况。

:::image type="content" source="./media/business-continuity/concepts-high-availability-steady-state.png" alt-text="区域冗余高可用性"::: 

1. 客户端连接到灵活的服务器并执行写入操作。
2. 更改会复制到备用站点。
3. 主接收确认。
4. 写入/提交已确认。

## <a name="failover-process---planned-downtimes"></a>故障转移进程-计划的停机时间

计划停机事件包括 Azure 计划定期软件更新和次版本升级。 在高可用性中进行配置时，这些操作首先应用于备用副本，同时应用程序继续访问主服务器。 更新备用副本后，主服务器连接将耗尽，并触发故障转移，这会激活备用副本，使其成为具有相同数据库服务器名称的主副本。 客户端应用程序将必须使用相同的数据库服务器名称重新连接到新的主服务器，并且可以恢复其操作。 新的备用服务器将与旧的主服务器建立在同一区域中。 

对于其他用户启动的操作（如缩放计算或缩放存储），更改将首先应用于备用，然后是主副本。 目前，连接不会故障转移到备用服务器，因此，在主服务器上执行操作时将导致停机。

### <a name="reducing-planned-downtime-with-managed-maintenance-window"></a>通过托管维护时段减少计划停机时间

 你可以通过在首选项的一天中选择一个30分钟的时段来计划 Azure 启动的维护活动，其中，数据库上的活动预计会较低。 Azure 维护任务（如修补程序）或次要版本升级将在该窗口中发生。  对于配置了高可用性的灵活服务器，将首先在备用副本上执行这些维护活动，然后将其激活。 然后，应用程序会重新连接到新的主服务器，并在预配新的备用服务器时恢复其操作。

## <a name="failover-process---unplanned-downtimes"></a>故障转移进程-计划外停机时间

计划外停机包括软件错误或基础结构组件故障会影响数据库的可用性。 当监视系统检测到服务器不可用时，将断开到备用副本的复制，并激活备用副本以作为主数据库服务器。 客户端可以使用相同的连接字符串重新连接到数据库服务器，并恢复其操作。 总体故障转移时间应为120s。 不过，故障转移时，可能需要更长时间，具体取决于故障转移时主数据库服务器中的活动（如大型事务和恢复时间）。

:::image type="content" source="./media/business-continuity/concepts-high-availability-failover-state.png" alt-text="区域冗余高可用性"::: 

1. 主数据库服务器已关闭，客户端失去了数据库连接。 
2. 激活备用服务器，使其成为新的主服务器。 客户端使用相同的连接字符串连接到新的主服务器。 使客户端应用程序位于与主数据库服务器相同的区域中可减少延迟并提高性能。
3. 备用服务器建立在与旧的主服务器相同的区域中，并启动流式复制。 
4. 建立稳定状态的复制后，在这两个站点上保存数据后，将确认客户端应用程序提交和写入。

## <a name="point-in-time-restore"></a>时点还原 

配置有高可用性的灵活服务器，将数据实时复制到备用服务器，以使其保持最新状态。 主服务器上的任何用户错误（例如，意外删除表或不正确的数据更新）都将切实复制到备用副本。 因此，不能使用备用恢复此类逻辑错误。 若要从这类错误中恢复，你必须从备份执行时间点还原。  使用灵活服务器的时间点还原功能，你可以还原到发生错误之前的时间。 对于配置了高可用性的数据库，将使用用户提供的名称将新的数据库服务器还原为单一区域灵活服务器。 然后，可以从数据库服务器中导出对象，并将其导入到生产数据库服务器。 同样，如果你想要克隆你的数据库服务器以便进行测试和开发，或者出于任何其他目的要进行还原，则可以执行时间点还原。

## <a name="zone-redundant-high-availability---features"></a>区域冗余高可用性-功能

-   备用副本将部署在与主服务器完全相同的 VM 配置中，包括 Vcore、storage、network settings (VNET、Firewall) 等。

-   能够添加现有数据库服务器的高可用性。

-   可以通过禁用高可用性来删除备用副本。

-   能够为主数据库服务器选择可用性区域。

-   能够停止、启动和重新启动主数据库服务器和备用数据库服务器。

-   自动备份从主数据库服务器执行并存储在区域冗余存储中。

-   客户端始终连接到主数据库服务器。

-   能够重新启动服务器以获取任何静态服务器参数更改。
  
-   定期维护活动（例如次版本升级）在备用状态第一次发生，并且服务故障转移以缩短停机时间。  

## <a name="zone-redundant-high-availability---limitations"></a>区域冗余高可用性-限制

-   可突增计算层不支持高可用性。
-   仅在有多个区域可用的区域中支持高可用性。
-   由于同步复制到另一个可用性区域，应用程序可能会遇到提升的写入和提交延迟。

-   备用副本不能用于只读查询。

-   故障转移时，可能需要长达两分钟或更长时间才能完成故障转移。

-   重新启动主数据库服务器以选取静态参数更改也会重启备用副本。

-   不支持配置其他读取副本。

-   在托管维护时段无法计划配置客户启动的管理任务。

-   计划事件（如缩放计算和缩放存储）先在备用服务器中进行，然后在主服务器中进行。 服务不进行故障转移。 

## <a name="next-steps"></a>后续步骤

-   了解 [业务连续性](./concepts-business-continuity.md)
-   了解如何 [管理高可用性](./how-to-manage-high-availability-portal.md)
-   了解 [备份和恢复](./concepts-backup-restore.md)