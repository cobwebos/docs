---
title: 使用 Azure 事件中心的共享访问签名授权访问权限
description: 本文提供了有关使用共享访问签名 (SAS) 授权访问 Azure 事件中心资源的信息。
services: event-hubs
ms.service: event-hubs
documentationcenter: ''
author: spelluru
ms.topic: conceptual
ms.date: 08/22/2019
ms.author: spelluru
ms.openlocfilehash: bdb1896f8a40c6de21ae76b536bfccec316341cd
ms.sourcegitcommit: 007ee4ac1c64810632754d9db2277663a138f9c4
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/23/2019
ms.locfileid: "69992791"
---
# <a name="authorizing-access-to-event-hubs-resources-using-shared-access-signatures"></a>使用共享访问签名授权访问事件中心资源
共享访问签名 (SAS) 提供了一种方法, 用于授予对事件中心命名空间中的资源的有限访问权限。 SAS 基于授权规则保护对事件中心资源的访问。 这些规则是在命名空间或实体 (事件中心或主题) 上配置的。 本文概述 SAS 模型, 并查看 SAS 最佳实践。

## <a name="what-are-shared-access-signatures"></a>什么是共享访问签名？
共享访问签名 (SAS) 基于授权规则提供对事件中心资源的委托访问。 授权规则具有与特定权限关联的名称，并包含一个加密密钥对。 可以通过事件中心客户端或自己的代码使用规则的名称和密钥来生成 SAS 令牌。 然后, 客户端可以将令牌传递到事件中心, 以证明请求的操作的授权。

SAS 是使用简单令牌的基于声明的授权机制。 使用 SAS 时，永远不会通过网络传递密钥。 密钥用于以加密方式将信息签名，以后，服务可以验证这些信息。 可以像使用用户名和密码一样使用 SAS。在用户名和密码方案中，客户端直接拥有授权规则名称和匹配的密钥。 SAS 可用于类似于联合安全模型, 在该模型中, 客户端从 security token service 接收经过时间限制和签名的访问令牌, 而无需拥有签名密钥。

> [!NOTE]
> Azure 事件中心支持使用 Azure Active Directory (Azure AD) 授权到事件中心资源。 使用 Azure AD 返回的 OAuth 2.0 令牌授权用户或应用程序可提供更高的安全性, 并可通过共享访问签名 (SAS) 轻松使用。 在 Azure AD 中, 无需在代码中存储令牌并存在潜在的安全漏洞。
>
> Microsoft 建议尽可能将 Azure AD 与 Azure 事件中心应用程序结合使用。 有关详细信息, 请参阅[使用 Azure Active Directory 授予对 Azure 事件中心资源的访问权限](authorize-access-azure-active-directory.md)。

> [!IMPORTANT]
> SAS (共享访问签名) 令牌对保护资源至关重要。 提供粒度时, SAS 授予客户端对事件中心资源的访问权限。 它们不应公开共享。 共享时, 如果需要解决这些问题, 请考虑使用任何日志文件的精简版本或从日志文件中删除 SAS 令牌 (如果存在), 并确保屏幕截图不包含 SAS 信息。

## <a name="shared-access-authorization-policies"></a>共享访问授权策略
每个事件中心命名空间和每个事件中心实体 (事件中心实例或 Kafka 主题) 都具有由规则组成的共享访问授权策略。 命名空间级别的策略应用到该命名空间中的所有实体，不管这些实体各自的策略配置如何。
对于每个授权策略规则, 需要确定三个信息片段: 名称、范围和权限。 该名称是该范围内的唯一名称。 作用域是相关资源的 URI。 对于事件中心命名空间, 范围是完全限定的域名 (FQDN), 例如`https://<yournamespace>.servicebus.windows.net/`。

策略规则提供的权限可以是以下内容的组合:
- **发送** –提供向实体发送消息的权限
- **侦听**–授予侦听或接收实体的权限
- **管理**–提供管理命名空间拓扑的权限, 包括创建和删除实体

> [!NOTE]
> "**管理**" 权限包括 "**发送**" 和 "**侦听**" 权限。

命名空间或实体策略最多可以包含12个共享访问授权规则, 为三组规则提供空间, 每个规则包含基本权限以及发送和侦听的组合。 此限制为 SAS 策略存储不应为用户或服务帐户存储的下划线。 如果你的应用程序需要基于用户或服务标识授予对事件中心资源的访问权限, 则它应实现在身份验证和访问检查后颁发 SAS 令牌的 security token service。

授权规则分配有一个主密钥和一个**辅助密钥**。 这些密钥是加密型强密钥。 请勿丢失或泄漏它们。 它们将在 Azure 门户中始终可用。 可以使用其中一个生成的密钥，并且随时可以重新生成密钥。 如果重新生成或更改策略中的密钥，以前基于该密钥颁发的所有令牌会立即失效。 但是，基于此类令牌创建的现有连接将继续工作，直到该令牌过期。

创建事件中心命名空间时, 会自动为该命名空间创建名为**RootManageSharedAccessKey**的策略规则。 此策略对整个命名空间具有 "**管理**" 权限。 建议将此规则视为管理根帐户, 而不要在应用程序中使用它。 可以通过 PowerShell 或 Azure CLI 在门户的 "**配置**" 选项卡中创建其他策略规则。

## <a name="best-practices-when-using-sas"></a>使用 SAS 的最佳实践
在应用程序中使用共享访问签名时，需要知道以下两个可能的风险：

- 如果 SAS 泄露, 则获取它的任何人都可以使用它, 这可能会损害事件中心资源。
- 如果提供给客户端应用程序的 SAS 到期并且应用程序无法从服务中检索新的 SAS, 则可能会影响应用程序的功能。

下面这些针对使用共享访问签名的建议可帮助降低这些风险：

- **如果需要, 让客户端自动续订 SAS**:在过期之前, 客户端应续订 SAS, 以便在提供 SAS 的服务不可用时允许重试的时间。 如果你的 SAS 要用于少量即时的短期操作, 这些操作预计会在有效期内完成, 则可能不必要, 因为不应续订 SAS。 但是，如果客户端定期通过 SAS 发出请求，则有效期可能就会起作用。 重要的考虑因素是, 将 SAS 的需求与生存期保持平衡 (如前文所述), 并确保客户端尽快请求续订 (以免在成功续订前因 SAS 到期而中断)。
- **请注意 SAS 开始时间**:如果将 SAS 的开始时间设置为 "**现在**", 则由于时钟偏移 (根据不同计算机, 当前时间中的差异), 在前几分钟可能会间歇地观察到失败。 通常，将开始时间至少设置为 15 分钟前。 或者根本不设置, 这会使它在所有情况下都能立即生效。 同样, 这也适用于到期时间。 请记住, 对于任何请求, 在任一方向上都可以观察到最多15分钟的时钟偏差。 
- **特定于要访问的资源**:最佳安全做法是向用户提供所需的最低特权。 如果某一用户仅需要对单个实体的读取访问权限，则向该用户授予对该单个实体的读取访问权限，而不要授予针对所有实体的读取/写入/删除访问权限。 它还有助于减少 SAS 损坏的原因, 因为 SAS 会使攻击者获得更少的电量。
- **请勿始终使用 SAS**:有时, 与事件中心的特定操作相关的风险超出 SAS 的优点。 对于此类操作, 请创建在业务规则验证、身份验证和审核后写入事件中心的中间层服务。
- **始终使用 HTTPs**:始终使用 Https 创建或分发 SAS。 如果 SAS 通过 HTTP 传递并且被截取, 则执行中间人连接的攻击者能够读取 SAS, 然后使用它, 就像目标用户可能具有的一样, 这可能会破坏敏感数据或允许恶意用户损坏数据。

## <a name="conclusion"></a>结束语
共享访问签名适用于向客户端提供事件中心资源的有限权限。 它们是使用 Azure 事件中心的任何应用程序的安全模型的重要部分。 如果按照本文中列出的最佳实践进行操作, 则可以使用 SAS 为资源提供更大的灵活性, 而不会影响应用程序的安全性。

## <a name="next-steps"></a>后续步骤
请参阅以下相关文章: 

- [使用 Azure Active Directory 对应用程序中的 Azure 事件中心的请求进行身份验证](authenticate-application.md)
- [使用 Azure Active Directory 验证托管标识, 以访问事件中心资源](authenticate-managed-identity.md)
- [使用共享访问签名对 Azure 事件中心的请求进行身份验证](authenticate-shared-access-signature.md)
- [使用 Azure Active Directory 授权访问事件中心资源](authorize-access-azure-active-directory.md)


