---
title: 多租户和内容隔离
titleSuffix: Azure Cognitive Search
description: 了解使用 Azure 认知搜索时多租户 SaaS 应用程序的常见设计模式。
manager: nitinme
author: LiamCavanagh
ms.author: liamca
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 11/04/2019
ms.openlocfilehash: d37abd1b5d212c3d920cb68b6236029b2112ae24
ms.sourcegitcommit: 598c5a280a002036b1a76aa6712f79d30110b98d
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/15/2019
ms.locfileid: "74113272"
---
# <a name="design-patterns-for-multitenant-saas-applications-and-azure-cognitive-search"></a>多租户 SaaS 应用程序和 Azure 认知搜索的设计模式
多租户应用程序可以为无法看到或共享任何其他租户数据的任意数量的租户，提供相同服务和功能。 本文档讨论了用 Azure 认知搜索构建的多租户应用程序的租户隔离策略。

## <a name="azure-cognitive-search-concepts"></a>Azure 认知搜索概念
作为一种搜索即服务解决方案，Azure 认知搜索允许开发人员将丰富的搜索体验添加到应用程序，而无需管理任何基础结构或成为信息检索的专家。 数据上载到服务，并存储在云中。 使用对 Azure 认知搜索 API 的简单请求，可以修改和搜索数据。 [此文](https://aka.ms/whatisazsearch)提供了服务概述。 在讨论设计模式之前，请务必了解 Azure 认知搜索中的一些概念。

### <a name="search-services-indexes-fields-and-documents"></a>搜索服务、索引、字段和文档
使用 Azure 认知搜索时，会订阅*搜索服务*。 将数据上传到 Azure 认知搜索时，它将存储在搜索服务中的*索引*内。 单个服务中可能有大量索引。 若要利用熟悉的数据库概念，搜索服务可以比作一个数据库，而服务中的索引可以比作数据库中的表。

搜索服务中的每个索引具有自己的架构，由大量的可自定义*字段*定义。 数据将以单个*文档*的形式添加到 Azure 认知搜索索引。 每个文档都必须上传到一个特定索引，并且必须适合该索引的架构。 使用 Azure 认知搜索搜索数据时，将针对特定索引发出全文搜索查询。  若要与数据库中的概念进行比较，字段可以比作表中的列，文档可以比作行。

### <a name="scalability"></a>可伸缩性
标准[定价层](https://azure.microsoft.com/pricing/details/search/)中的任何 Azure 认知搜索服务都可以在两个维度中进行缩放：存储和可用性。

* 可以添加*分区*以便增加搜索服务的存储。
* 可以将*副本*添加到服务中，以便增加搜索服务可处理请求的吞吐量。

添加和删除分区以及副本，可使搜索服务的容量随着应用程序需要的大量数据和流量一起增加。 为了使搜索服务实现读取 [SLA](https://azure.microsoft.com/support/legal/sla/search/v1_0/)，需要两个副本。 为了使服务实现读写 [SLA](https://azure.microsoft.com/support/legal/sla/search/v1_0/)，需要三个副本。

### <a name="service-and-index-limits-in-azure-cognitive-search"></a>Azure 认知搜索中的服务和索引限制
Azure 认知搜索中有几个不同的[定价层](https://azure.microsoft.com/pricing/details/search/)，每个层都有不同的[限制和配额](search-limits-quotas-capacity.md)。 有一些限制位于服务级别，有一些位于索引级别，还有一些位于分区级别。

|  | 基本 | 标准 1 | 标准 2 | 标准 3 | 标准 3 HD |
| --- | --- | --- | --- | --- | --- |
| 每个服务的副本数上限 |3 |12 |12 |12 |12 |
| 每个服务的分区数上限 |1 |12 |12 |12 |3 |
| 每个服务的搜索单位数上限（副本*分区） |3 |36 |36 |36 |36（最多 3 个分区） |
| 每个服务的存储上限 |2 GB |300 GB |1.2 TB |2.4 TB |600 GB |
| 每个分区的存储上限 |2 GB |25 GB |100 GB |200 GB |200 GB |
| 每个服务的索引数上限 |5 |50 |200 |200 |3000（最多 1000 个索引/分区） |

#### <a name="s3-high-density"></a>S3 高密度
在 Azure 认知搜索的 S3 定价层中，有一个针对多租户方案专门设计的高密度（HD）模式选项。 在许多情况下，都有必要支持单个服务下的大量较小租户，从而获得简洁性和成本效益带来的优势。

S3 HD 通过以使用分区扩展索引的能力，换得在单个服务中承载更多索引的能力，允许多个小索引在单个搜索服务中填满并受其管理。

具体而言，S3 服务可以具有 1 到 200 个索引，总共可承载多达 14 亿文档。 另一方面，S3 HD 仅允许各索引最多承载 100 万个文档，但它可以处理每个分区多达 1000 个索引（每个服务多达 3000 个），因此每个分区总文档计数为 2 亿（每个服务多达 6 亿）。

## <a name="considerations-for-multitenant-applications"></a>多租户应用程序注意事项
多租户应用程序必须在租户之间高效分配资源，同时在各租户之间保持一定程度的隐私。 设计此类应用程序的体系结构时需要了解几个注意事项：

* *租户隔离*：应用程序开发人员需要采取适当措施确保没有未经授权的租户，或者不会出现对其他租户数据的意外访问。 从数据隐私的角度之上来看，租户隔离策略需要有效管理共享资源并且避免受到干扰性邻户影响。
* *云资源成本：* 与任何其他应用程序一样，软件解决方案必须将保持成本竞争力作为多租户应用程序的一部分考虑。
* *操作易用性：* 开发多租户体系结构时，对应用程序操作和复杂性的影响是一个重要的考虑因素。 Azure 认知搜索的[SLA 为 99.9%](https://azure.microsoft.com/support/legal/sla/search/v1_0/)。
* *全球分布：* 多租户应用程序可能需要高效地为分布在全球范围内的租户提供服务。
* *可扩展性：* 应用程序开发人员需要考虑如何在以下二者之间进行协调：维护足够低级别的应用程序复杂性和设计随着租户数量和租户数据与工作负载增加进行缩放的应用程序。

Azure 认知搜索提供几个边界，可用于隔离租户的数据和工作负荷。

## <a name="modeling-multitenancy-with-azure-cognitive-search"></a>用 Azure 认知搜索为多租户建模
对于多租户方案，应用程序开发人员使用一个或多个搜索服务，并在各服务和/或各索引中划分其租户。 为多租户方案建模时，Azure 认知搜索具有几种常见模式：

1. *每租户索引：* 每个租户都在搜索服务中有自己的索引，可与其他租户共享。
2. *每租户服务：* 每个租户都有自己的专用 Azure 认知搜索服务，提供最高级别的数据和工作负荷分离。
3. *二者混合：* 为较大、活跃度较高的租户分配专用服务，而为较小的租户分配共享服务中的各个索引。

## <a name="1-index-per-tenant"></a>1. 每个租户的索引
![每租户索引模型描绘](./media/search-modeling-multitenant-saas-applications/azure-search-index-per-tenant.png)

在每个租户索引模型中，多个租户占用单个 Azure 认知搜索服务，其中每个租户都有自己的索引。

租户实现数据隔离，因为所有搜索请求和文档操作都在 Azure 认知搜索的索引级别发出。 在应用程序层中，要带着需求意识将各租户的流量定向到正确的索引，同时还要跨所有租户在服务级别上管理资源。

每租户索引模型的一个关键特性是应用程序开发人员能够在应用程序的租户之间超额订阅搜索服务容量。 如果租户的工作负载分布不均，最佳租户组合可以是跨搜索服务索引分布，以便容纳大量高度活跃的资源密集型租户，同时又能够为活跃度较低但具有长尾效应的租户提供服务。 弊端是模型无法处理每个租户同时高度活跃的情况。

每租户索引模型提供可变成本模型的基础，在此模型中，整个 Azure 认知搜索服务将提前购买，并随后使用租户进行填充。 这样可以为试用和免费帐户指定未使用的容量。

对于全球分布的应用程序，每租户索引模型可能不是最有效的。 如果应用程序的租户在全球分布，每个区域可能都需要一个单独的服务，而每个都可能叠加成本。

Azure 认知搜索允许对单个索引和索引总数进行缩放。 如果选择相应的定价层，当服务中的单个索引在存储或流量方面增长到过于庞大时，可以向整个搜索服务增加分区和副本。

如果索引总数对于单个服务而言增长过高，另一个服务必须预配为能够容纳新租户。 如果在添加新服务时必须在搜索服务之间移动索引，则必须将索引中的数据手动复制到另一索引，因为 Azure 认知搜索不允许移动索引。

## <a name="2-service-per-tenant"></a>2. 每个租户的服务
![每租户服务模型描绘](./media/search-modeling-multitenant-saas-applications/azure-search-service-per-tenant.png)

在每租户服务体系结构中，每个租户都有自己的搜索服务。

在此模型中，应用程序为其租户实现最高隔离级别。 每个服务都有专用存储和吞吐量，用于处理搜索请求以及单独的 API 密钥。

对于每个租户具有较大分布范围或租户与租户之间工作负载差异不大的应用程序而言，每租户服务模型是一个有效的选择，因为资源不在各租户的工作负载之间共享。

每租户服务模型还提供可预测、成本固定模型的优势。 在填充租户之前，无需在整个搜索服务中进行前期投资，但是每租户成本高于每租户索引模型。

每租户服务模型对于全球分布的应用程序而言是一种高效选择。 对于地域分布式租户，很难在相应的区域中让每个租户都拥有服务。

当各租户发展过快使其服务不再适用时，扩展此模式将遇到困难。 Azure 认知搜索当前不支持升级搜索服务的定价层，因此必须将所有数据手动复制到新服务。

## <a name="3-mixing-both-models"></a>3. 混合两种模型
另一种对多组织建模的模式是混合使用每租户索引和每租户服务策略。

通过混合使用这两种模式，应用程序的最大租户可以占用专用服务，而活跃度较低且具有长尾效应的较小租户可以占用共享服务中的索引。 此模型可确保最大租户持续享有服务的高性能，同时帮助较小租户避免受到干扰性邻户的影响。

但是，实现此策略依赖于远见性，要预测哪些租户将需要专用服务，哪些将需要共享服务中的索引。 应用程序复杂性随着这两种多组织模型的管理需求而增长。

## <a name="achieving-even-finer-granularity"></a>实现更精细的粒度
上述用于对 Azure 中的多租户方案建模的设计模式认知搜索采用统一的作用域，其中每个租户都是应用程序的整个实例。 但是，应用程序有时可能处理多个较小的范围。

如果每租户服务和每租户索引模型不是足够小的范围，则无法对索引建模以实现更精细的粒度。

若要使单个索引的行为与其他客户端终结点有所不同，可以向索引添加字段，为每个可能的客户端指定某个值。 每次客户端调用 Azure 认知搜索查询或修改索引时，客户端应用程序中的代码会在查询时使用 Azure 认知搜索的[筛选器](https://msdn.microsoft.com/library/azure/dn798921.aspx)功能为该字段指定合适的值。

此方法可用于实现单独用户帐户的功能、分隔权限级别甚至完全分隔应用程序。

> [!NOTE]
> 如果使用上面介绍的方法将单个索引配置为为多个租户提供服务，将影响搜索结果的相关性。 搜索相关性分数在索引级范围（而不是租户级范围）内计算，因此所有租户的数据都纳入相关性分数的基础统计数据（如术语频率）。
> 
> 

## <a name="next-steps"></a>后续步骤
对于许多应用程序而言，Azure 认知搜索是一种极具吸引力的选择。 为多租户应用程序评估各种设计模式时，请考虑[各种定价层](https://azure.microsoft.com/pricing/details/search/)和各自的[服务限制](search-limits-quotas-capacity.md)，以便最佳地定制 Azure 认知搜索以适应所有规模的应用程序工作负荷和体系结构。

可以将有关 Azure 认知搜索和多租户方案的任何问题定向到 azuresearch_contact@microsoft.com。

