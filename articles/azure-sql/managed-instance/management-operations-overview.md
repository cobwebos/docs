---
title: 管理操作概述
titleSuffix: Azure SQL Managed Instance
description: 了解 Azure SQL 托管实例管理操作的持续时间和最佳做法。
services: sql-database
ms.service: sql-managed-instance
ms.subservice: operations
ms.custom: ''
ms.devlang: ''
ms.topic: overview
author: urosmil
ms.author: urmilano
ms.reviewer: sstein, MashaMSFT
ms.date: 07/10/2020
ms.openlocfilehash: 2da7311e61aa39be69a6a0a29eff686baaad7ebf
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/09/2020
ms.locfileid: "91323186"
---
# <a name="overview-of-azure-sql-managed-instance-management-operations"></a>Azure SQL 托管实例管理操作概述
[!INCLUDE[appliesto-sqlmi](../includes/appliesto-sqlmi.md)]

Azure SQL 托管实例提供管理操作，你可以使用这些操作来自动部署新的托管实例、更新实例属性，以及删除不再需要的实例。

## <a name="what-are-management-operations"></a>什么是管理操作？

所有管理操作可分类为：

- 实例部署（创建新实例）
- 实例更新（更改实例属性，例如 vCore 或预留存储）
- 实例删除

为了支持 [Azure 虚拟网络中的部署](../../virtual-network/virtual-network-for-azure-services.md)并为客户提供隔离和安全性，SQL 托管实例依赖于[虚拟群集](connectivity-architecture-overview.md#high-level-connectivity-architecture)。 虚拟群集表示在客户的虚拟网络子网中部署的一组专用的独立虚拟机。 从本质上讲，部署到空子网的每个托管实例都会导致生成新的虚拟群集。

托管实例上的后续管理操作可能会影响基础虚拟群集。 影响基础虚拟群集的更改可能会影响管理操作的持续时间，因为部署额外的虚拟机会产生一笔开销，在计划新部署或对现有托管实例的更新时需要考虑这笔开销。


## <a name="duration"></a>持续时间

虚拟群集上的操作持续时间可能不同，但通常持续时间最长。 

下面是根据现有的服务遥测数据预期可得到的值：

- 虚拟群集创建：创建是实例管理操作中的一个同步步骤。 <br/> **90% 的操作可在 4 小时内完成**。
- 虚拟群集大小调整（扩展或收缩）：扩展是一个同步步骤，而收缩以异步方式执行（不影响实例管理操作的持续时间）。 <br/>**90% 的群集扩展操作可在 2.5 小时内完成**。
- 虚拟群集删除：删除是一个异步步骤，但也可以在空的虚拟群集上[手动启动](virtual-cluster-delete.md)，在这种情况下，它将以同步方式执行。 <br/>**90% 的虚拟群集删除操作可在 1.5 小时内完成**。

此外，实例管理还可能包括托管数据库上的某个操作，这会导致持续时间变长：

- **附加 Azure 存储中的数据库文件**：一个同步步骤，例如缩放计算大小 (vCore) 或在“常规用途”服务层级增加或减少存储空间。 <br/>**90% 的此类操作可在 5 分钟内完成**。
- Always On 可用性组种子设定：一个同步步骤，例如计算 (vCore)，或者“业务关键”服务层级中的存储缩放，以及将服务层级从“常规用途”更改为“业务关键”（反之亦然）。 此操作的持续时间与总数据库大小以及当前数据库活动（活动的事务数）成正比。 更新实例时执行数据库活动可能会使总持续时间发生明显的变化。 <br/>90% 的此类操作能够以 220 GB/小时或更高的速率执行。

下表根据操作类别汇总了操作和典型的总持续时间：

**类别：部署**

|操作  |长时间运行的分段  |预计持续时间  |
|---------|---------|---------|
|空子网中的第一个实例|虚拟群集的创建|90% 的操作可在 4 小时内完成。|
|非空子网中另一个硬件代系的第一个实例（例如，包含第 4 代实例的子网中的第一个 5 代实例）|创建虚拟群集<sup>1</sup>|90% 的操作可在 4 小时内完成。|
|在非空子网中创建后续实例（第 2 个、第 3 个 ... 实例）|虚拟群集大小调整|90% 的操作可在 2.5 小时内完成。|
| | | 

<sup>1</sup>虚拟群集是按硬件代系生成的。

**类别：更新**

|操作  |长时间运行的分段  |预计持续时间  |
|---------|---------|---------|
|实例属性更改（管理员密码、Azure AD 登录名、Azure 混合权益标志）|空值|最长 1 分钟。|
|增加/缩减实例存储空间（“常规用途”服务层级）|附加数据库文件|90% 的操作可在 5 分钟内完成。|
|实例存储纵向缩放（“业务关键”服务层级）|- 虚拟群集大小调整<br>- Always On 可用性组种子设定|90% 的操作可在“2.5 小时 + 所有数据库种子设定时间”内完成（220 GB/小时）。|
|实例计算 (vCore) 纵向缩放（“常规用途”）|- 虚拟群集大小调整<br>- 附加数据库文件|90% 的操作可在 2.5 小时内完成。|
|实例计算 (vCore) 纵向缩放（“业务关键”）|- 虚拟群集大小调整<br>- Always On 可用性组种子设定|90% 的操作可在“2.5 小时 + 所有数据库种子设定时间”内完成（220 GB/小时）。|
|实例服务层级更改（从“常规用途”更改为“业务关键”，或反之）|- 虚拟群集大小调整<br>- Always On 可用性组种子设定|90% 的操作可在“2.5 小时 + 所有数据库种子设定时间”内完成（220 GB/小时）。|
| | | 

**类别：删除**

|操作  |长时间运行的分段  |预计持续时间  |
|---------|---------|---------|
|实例删除|所有数据库的尾部日志备份|90% 的操作在最多 1 分钟内即可完成。<br>注意：如果删除了子网中的最后一个实例，则此操作将计划在 12 小时后删除虚拟群集。<sup>1</sup>|
|虚拟群集的删除（用户启动的操作）|虚拟群集的删除|90% 的操作可在最多 1.5 小时内可完成。|
| | | 

<sup>1</sup>当前配置的是 12 小时，但将来可能会更改。 如果需要提前删除虚拟群集（如释放子网），请参阅[在删除托管实例后删除子网](virtual-cluster-delete.md)。

## <a name="instance-availability"></a>实例可用性

SQL 托管实例在更新操作期间可用，但更新结束时发生的故障转移会导致短暂的停机期间。 即使长期事务已中断，但由于[加速数据库恢复](../accelerated-database-recovery.md)，它通常还会持续 10 秒钟。

在执行部署和删除操作期间，客户端应用程序无法使用 SQL 托管实例。

> [!IMPORTANT]
> 建议不要在运行长期事务（数据导入、数据处理作业、索引重新生成等）的同时缩放 Azure SQL 托管实例的计算大小或存储空间，也不要在此时更改服务层级。 操作结束时，数据库的故障转移将取消所有正在进行的事务。 

## <a name="management-operations-steps"></a>管理操作步骤

管理操作包括多个步骤。 [引入操作 API 后](management-operations-monitor.md)，这些步骤将对操作子集（部署和更新）公开。 部署操作包含 3 个步骤，更新操作则分为 6 个步骤。 有关操作持续时间的详细信息，请参阅[管理操作持续时间](#duration)部分。 按执行顺序列出步骤。

### <a name="managed-instance-deployment-steps"></a>托管实例部署步骤

|步骤名称  |步骤说明  |
|----|---------|
|请求验证 |验证已提交的参数。 如果配置错误，操作将失败并出现错误。 |
|虚拟群集大小调整/创建 |根据子网的状态，虚拟群集将进行创建或调整大小。 |
|启动新的 SQL 实例 |SQL 进程在已部署的虚拟群集上启动。 |

### <a name="managed-instance-update-steps"></a>托管实例更新步骤

|步骤名称  |步骤说明  |
|----|---------|
|请求验证 | 验证已提交的参数。 如果配置错误，操作将失败并出现错误。 |
|虚拟群集大小调整/创建 |根据子网的状态，虚拟群集将进行创建或调整大小。 |
|启动新的 SQL 实例 | SQL 进程在已部署的虚拟群集上启动。 |
|执行数据库文件种子设定/附加数据库文件 |根据更新操作的类型，执行数据库种子设定或附加数据库文件。 |
|故障转移准备和故障转移 |在对数据进行种子设定或重新附加数据库文件后，将准备好系统来进行故障转移。 设置了所有内容后，会执行故障转移，但有短暂的停机时间。 |
|清理旧的 SQL 实例 |从虚拟群集中删除旧的 SQL 进程 |

> [!NOTE]
> 由于缩放实例，基础虚拟群集将经历释放未使用的容量和可能的容量碎片整理的过程，这可能会影响未参与创建/缩放操作的实例。 


## <a name="management-operations-cross-impact"></a>管理操作交叉影响

对托管实例执行管理操作可能会影响放置在同一虚拟群集中的实例的其他管理操作：

- 虚拟群集中的长期还原操作将导致同一子网中的其他实例创建或缩放操作暂停。<br/>**示例：** 如果有长期还原操作，并且同一子网中存在创建或缩放请求，则此请求将需要更长的时间才能完成，因为它将等待还原操作完成，然后再继续。

- 后续实例的创建或缩放操作会因先前启动的实例创建或实例缩放请求（启动了虚拟群集大小调整）而暂停。<br/>**示例：** 如果同一虚拟群集下的同一子网中存在多个创建和/或缩放请求，且其中一个请求启动了虚拟群集的大小调整操作，则在初始操作请求起 5 分钟后提交的所有请求的持续时间将比预期的长，因为这些请求需要等待大小调整操作完成后才能继续。

- 在 5 分钟时间范围内提交的创建/缩放操作将以并行方式批处理和执行。<br/>**示例：** 对于在 5 分钟时间范围内提交的所有操作（从执行第一个操作请求的那一刻开始计算），只会执行一次虚拟群集大小调整。 如果另一个请求在提交第一个请求 5 分钟后才提交，则该请求将等待虚拟群集大小调整完成后才会开始执行。

> [!IMPORTANT]
> 由于另一个操作正在进行而被暂停的管理操作将在满足继续进行的条件后自动恢复。 无需任何用户操作即可恢复临时暂停的管理操作。

## <a name="monitoring-management-operations"></a>监视管理操作

若要了解如何监视管理操作进度和状态，请参阅[监视管理操作](management-operations-monitor.md)。

## <a name="canceling-management-operations"></a>取消管理操作

若要了解如何取消管理操作，请参阅[取消管理操作](management-operations-cancel.md)。


## <a name="next-steps"></a>后续步骤

- 若要了解如何创建第一个托管实例，请参阅[快速入门指南](instance-create-quickstart.md)。
- 有关功能和比较列表，请参阅[常用 SQL 功能](../database/features-comparison.md)。
- 有关 VNet 配置的详细信息，请参阅 [SQL 托管实例 VNet 配置](connectivity-architecture-overview.md)。
- 有关创建托管实例以及从备份文件还原数据库的快速入门，请参阅[创建托管实例](instance-create-quickstart.md)。
- 有关使用 Azure 数据库迁移服务进行迁移的教程，请参阅[使用数据库迁移服务进行 SQL 托管实例迁移](../../dms/tutorial-sql-server-to-managed-instance.md)。
