---
title: 地理围栏和地理空间的聚合方案中使用 Azure Stream Analytics
description: 本文介绍如何使用 Azure Stream Analytics 进行地理围栏和地理空间信息聚合。
services: stream-analytics
author: mamccrea
ms.author: mamccrea
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 04/02/2019
ms.openlocfilehash: cc301855e4cdcb8eb687e753835577399cfe72b0
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/23/2019
ms.locfileid: "60789533"
---
# <a name="geofencing-and-geospatial-aggregation-scenarios-with-azure-stream-analytics"></a>地理围栏和地理空间的聚合方案中使用 Azure Stream Analytics

通过内置的地理空间函数，可以使用 Azure Stream Analytics 来构建应用程序的方案，例如车队管理、 骑共享、 已连接的汽车和资产跟踪。

## <a name="geofencing"></a>地理围栏

在云中以及在 IoT Edge 运行时，azure Stream Analytics 支持较低的延迟实时地理围栏计算。

### <a name="geofencing-scenario"></a>地理围栏方案

一家制造公司需要跟踪上其建筑物的资产。 它们配备使用 GPS 每台设备，并且想要接收通知，如果设备离开某一特定区域。

此示例中使用引用数据具有建筑物和每个建筑物中允许的设备的地域隔离区信息。 请记住，引用数据可能是静态或缓慢更改。 对于此方案使用静态引用数据。 设备 ID 和其当前位置会连续发出数据的流。

### <a name="define-geofences-in-reference-data"></a>在引用数据中定义地域隔离区

可以使用 GeoJSON 对象定义地域隔离区。 对于兼容性版本 1.2 和更高版本的作业，地域隔离区还可以定义使用熟知文本 (WKT) 作为`NVARCHAR(MAX)`。 WKT 是开放地理空间信息联盟 (OGC) 标准，用于表示一种文本格式中的空间数据。

内置的地理空间函数可用于定义地域隔离区查明某个元素是否加入或退出特定地域隔离区多边形。

下表是可以在 Azure blob 存储或 Azure SQL 表中存储的地域隔离区引用数据的示例。 地理空间多边形、 表示的每个站点和每个设备程序与允许的站点 id。

|SiteID|SiteName|地理围栏|AllowedDeviceID|
|------|--------|--------|---------------|
|1|"雷德蒙德 Building 41"|"多边形 ((-122.1337357922017 47.63782998329432、-122.13373042778369 47.637634793257305、-122.13346757130023 47.637642022530954、-122.13348902897235 47.637508280806806、-122.13361777500506 47.637508280806806、-122.1336124105870347.63732393354484、-122.13265754417773 47.63730947490855、-122.13266290859576 47.637519124743164、-122.13302232460376 47.637515510097955、-122.13301696018573 47.63764925180358、-122.13272728161212 47.63764925180358、-122.1327487392842447.63784082716388、-122.13373579220172 47.63782998329432))"|"B"|
|2|"雷德蒙德 Building 40"|"多边形 ((-122.1336154507967 47.6366745947009、-122.13361008637867 47.636483015064535、-122.13349206918201 47.636479400347675、-122.13349743360004 47.63636372927573、-122.13372810357532 47.63636372927573、-122.1337334679933547.63617576323771、-122.13263912671528 47.63616491902258、-122.13264985555134 47.63635649982525、-122.13304682248554 47.636367344000604、-122.13305218690357 47.63650831807564、-122.13276250832996 47.636497473929516、-122.1327732371660247.63668543881025、-122.1336154507967 47.6366745947009))"|"A"|
|3|"雷德蒙德 Building 22"|"多边形 ((-122.13611660248233 47.63758544698554、-122.13635263687564 47.6374083293018、-122.13622389084293 47.63733603619712、-122.13622389084293 47.63717699101473、-122.13581619507266 47.63692757827657、-122.1355962539334447.637046862778135、-122.13569281345798 47.637144458985965、-122.13570890671207 47.637314348246214、-122.13611660248233 47.63758544698554))"|"C"|

### <a name="generate-alerts-with-geofence"></a>生成警报的地域隔离区

设备可以发出其 ID 和位置每隔一分钟通过名为流`DeviceStreamInput`。 下表是输入的流。

|设备ID|GeoPosition|
|--------|-----------|
|"A"|"POINT(-122.13292341559497 47.636318374032726)"|
|"B"|"POINT(-122.13338475554553 47.63743531308874)"|
|"C"|"POINT(-122.13354001095752 47.63627622505007)"|

可以编写一个查询的联接使用地域隔离区引用数据的设备流并在每次设备时允许构建之外生成警报。

```SQL
SELECT DeviceStreamInput.DeviceID, SiteReferenceInput.SiteID, SiteReferenceInput.SiteName 
INTO Output
FROM DeviceStreamInput 
JOIN SiteReferenceInput
ON st_within(DeviceStreamInput.GeoPosition, SiteReferenceInput.Geofence) = 0
WHERE DeviceStreamInput.DeviceID = SiteReferenceInput.AllowedDeviceID
```

下图表示地域隔离区。 您可以看到设备在根据输入的流数据中的位置。

![构建地域隔离区](./media/geospatial-scenarios/building-geofences.png)

生成 ID 为 2，这不允许根据引用数据位于设备"C"。 此设备应位于内生成 ID 为 3。 运行此作业将生成一个警报，以便此特定的冲突。

### <a name="site-with-multiple-allowed-devices"></a>站点具有多个允许的设备

如果站点允许多个设备，可以在定义的设备 Id 的数组`AllowedDeviceID`和用户定义函数可以用于`WHERE`子句，以验证流的设备 ID 如果与该列表中的任何设备 ID 相匹配。 详细信息，请查看[Javascript UDF](stream-analytics-javascript-user-defined-functions.md)教程，了解云作业并[ C# UDF](stream-analytics-edge-csharp-udf.md)教程，了解 edge 作业。

## <a name="geospatial-aggregation"></a>地理空间信息聚合

在云中以及在 IoT Edge 运行时，azure Stream Analytics 支持实时地理空间信息的低延迟聚合。

### <a name="geospatial-aggregation-scenario"></a>地理空间信息聚合方案

Cab 公司想要构建实时应用程序，指导他们寻找针对当前遇到更多需求的城市的区域持续一段时间的 cab 驱动程序。

该公司将城市的逻辑区域存储为引用数据。 每个区域定义 RegionID、 区域名称和地域隔离区。

### <a name="define-the-geofences"></a>定义地域隔离区

下表是可以在 Azure blob 存储或 Azure SQL 表中存储的地域隔离区引用数据的示例。 每个区域表示的地理空间多边形，用于将与来自流式处理数据的请求相关联。

这些多边形仅供参考，并不代表实际的城市逻辑或物理分离。

|RegionID|RegionName|地理围栏|
|--------|----------|--------|
|第|"SoHo"|"多边形 ((-74.00279525078275 40.72833625216264、-74.00547745979765 40.721929158663244、-74.00125029839018 40.71893680218994、-73.9957785919998 40.72521409075776、-73.9972377137039 40.72557184584898、-74.00279525078275 40.72833625216264))"|
|2|"Chinatown"|"多边形 ((-73.99712367114876 40.71281582267133、-73.9901070123658 40.71336881907936、-73.99023575839851 40.71452359088633、-73.98976368961189 40.71554823078944、-73.99551434573982 40.717337246783735、-73.9948062425598940.718491949759304、-73.99652285632942 40.719109951574、-73.99776740131233 40.7168005470334、-73.99903340396736 40.71727219249899、-74.00193018970344 40.71938642421256、-74.00409741458748 40.71688186545551、-74.0005139833435840.71517415773184、-74.0004281526551 40.714377212470005、-73.99849696216438 40.713450141693166、-73.99748845157478 40.71405192594819、-73.99712367114876 40.71281582267133))"|
|3|"Tribeca 中时"|"多边形 ((-74.01091641815208 40.72583120006787、-74.01338405044578 40.71436586362705、-74.01370591552757 40.713617702123415、-74.00862044723533 40.711308107057235、-74.00194711120628 40.7194238654018、-74.0109164181520840.72583120006787))"|

### <a name="aggregate-data-over-a-window-of-time"></a>时间窗口内的聚合数据

下表包含流式处理数据的"搭乘。"

|UserID|FromLocation|ToLocation|TripRequestedTime|
|------|------------|----------|-----------------|
|"A"|"POINT(-74.00726861389182 40.71610611981975)"|"POINT(-73.98615095917779 40.703107386025835)"|"2019-03-12T07:00:00Z"|
|"B"|"POINT(-74.00249841021645 40.723827238895666)"|"POINT(-74.01160699942085 40.71378884930115)"|"2019-03-12T07:01:00Z"|
|"C"|"POINT(-73.99680120565864 40.716439898624024)"|"POINT(-73.98289663412544 40.72582343969828)"|"2019-03-12T07:02:00Z"|
|"D"|"POINT(-74.00741090068288 40.71615626755086)"|"POINT(-73.97999843120539 40.73477895807408)"|"2019-03-12T07:03:00Z"|

下面的查询联接使用地域隔离区引用数据的设备流，并计算每个区域上的时间窗口为 15 分钟内每隔一分钟的请求数。

```SQL
SELECT count(*) as NumberOfRequests, RegionsRefDataInput.RegionName 
FROM UserRequestStreamDataInput
JOIN RegionsRefDataInput 
ON st_within(UserRequestStreamDataInput.FromLocation, RegionsRefDataInput.Geofence) = 1
GROUP BY RegionsRefDataInput.RegionName, hoppingwindow(minute, 1, 15)
```

此查询按市/县内的每个区域输出请求的计数过去 15 分钟内每隔一分钟。 此信息可由 Power BI 仪表板，轻松地显示或可作为通过与 Azure functions 等服务集成的 SMS 文本消息广播到所有驱动程序。

下图说明了对 Power BI 仪表板的查询的输出。 

![在 Power BI 仪表板上的结果输出](./media/geospatial-scenarios/power-bi-output.png)


## <a name="next-steps"></a>后续步骤

* [Stream Analytics 地理空间函数简介](stream-analytics-geospatial-functions.md)
* [地理空间函数 (Azure Stream Analytics)](https://docs.microsoft.com/stream-analytics-query/geospatial-functions)
